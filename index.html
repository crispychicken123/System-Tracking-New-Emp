<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Crispy Chicken - HR & Compliance System</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
  /* --- CSS VARIABLES --- */
  :root {
    --cc-red: #E4002B;
    --cc-black: #1a1a1a;
    --cc-white: #ffffff;
    --cc-gray: #f4f6f9;
    --cc-border: #e0e0e0;
    --cc-text-muted: #666;
    --cc-bg-modal: #ffffff;
    --cc-table-hover: rgba(0,0,0,0.02);
    --color-warning: #f59e0b;
    --color-danger: #dc3545;
    --color-success: #10b981;
    --color-info: #3b82f6;
  }

  [data-theme="dark"] {
    --cc-black: #f0f0f0;
    --cc-white: #1e1e1e;
    --cc-gray: #252526;
    --cc-border: #333;
    --cc-text-muted: #aaa;
    --cc-bg-modal: #2d2d2d;
    --cc-table-hover: rgba(255,255,255,0.05);
  }

  * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--cc-gray);
    margin: 0;
    padding: 0;
    color: var(--cc-black);
    transition: background-color 0.3s, color 0.3s;
    min-height: 100vh;
  }

  /* --- HEADER --- */
  header {
    background-color: var(--cc-white); color: var(--cc-black);
    padding: 12px 24px; display: flex; align-items: center; justify-content: space-between;
    border-bottom: 4px solid var(--cc-red); position: sticky; top: 0; z-index: 100;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }
  .logo-area { display: flex; align-items: center; gap: 12px; }
  .chef-icon { font-size: 28px; background: var(--cc-red); color: white; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; }
  .app-title h1 { margin: 0; font-size: 18px; font-weight: 700; }
  .app-title span { font-size: 11px; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; }

  .header-actions { display: flex; gap: 15px; align-items: center; position: relative; }
  .header-btn { background: none; border: none; font-size: 16px; cursor: pointer; color: var(--cc-text-muted); transition: color 0.2s; position: relative; padding: 8px; }
  .header-btn:hover { color: var(--cc-black); }
  .badge-notify { position: absolute; top: -5px; right: -5px; background: var(--color-danger); color: white; font-size: 10px; padding: 2px 5px; border-radius: 10px; display: none; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

  /* --- Controls --- */
  .controls { padding: 15px 24px; background: var(--cc-white); display: flex; gap: 12px; align-items: center; border-bottom: 1px solid var(--cc-border); flex-wrap: wrap; }
  .search-wrapper { flex: 1; min-width: 200px; position: relative; }
  .search-wrapper input { width: 100%; padding: 10px 10px 10px 35px; border: 1px solid var(--cc-border); border-radius: 20px; font-size: 14px; background-color: var(--cc-gray); color: var(--cc-black); }
  .search-wrapper input:focus { border-color: var(--cc-red); }
  .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #888; }

  button { padding: 9px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; color: white; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s; }
  button:hover { opacity: 0.9; transform: translateY(-1px); }
  button:active { transform: translateY(0); }
  .btn-add { background-color: var(--cc-red); }
  .btn-export { background-color: #28a745; }
  .btn-print { background-color: #6c757d; }

  /* --- Dashboard --- */
  .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; padding: 20px 24px 0 24px; }
  .stat-card { background: var(--cc-white); padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.03); border-top: 4px solid transparent; display: flex; flex-direction: column; align-items: center; }
  .stat-number { font-size: 28px; font-weight: 800; color: var(--cc-black); margin-bottom: 2px; }
  .stat-label { font-size: 11px; font-weight: 600; color: var(--cc-text-muted); text-transform: uppercase; }
  
  .stat-total { border-color: #666; } .stat-new { border-color: #3b82f6; } 
  .stat-active { border-color: #10b981; } .stat-alert { border-color: #f59e0b; }

  /* --- Table --- */
  .table-container { margin: 20px 24px 24px 24px; background: var(--cc-white); border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.03); border: 1px solid var(--cc-border); overflow: hidden; }
  .table-header { padding: 12px 20px; background: var(--cc-gray); border-bottom: 1px solid var(--cc-border); display: flex; justify-content: space-between; align-items: center; }
  .table-scroll { overflow-x: auto; max-height: calc(100vh - 260px); }
  table { width: 100%; border-collapse: collapse; min-width: 1800px; }
  th { background-color: var(--cc-gray); color: var(--cc-text-muted); font-weight: 700; font-size: 11px; text-transform: uppercase; padding: 12px 10px; text-align: left; border-bottom: 2px solid var(--cc-border); position: sticky; top: 0; z-index: 10; }
  td { padding: 10px; border-bottom: 1px solid var(--cc-border); font-size: 13px; color: var(--cc-black); vertical-align: middle; }
  tr:hover { background-color: var(--cc-table-hover); }
  tr.new-staff-row { background-color: rgba(59, 130, 246, 0.03); border-left: 3px solid #3b82f6; }
  tr.alert-row { background-color: rgba(245, 158, 11, 0.03); border-left: 3px solid #f59e0b; }

  /* Status & Badges */
  .badge { padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
  .status-warning { background-color: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
  .status-expired { background-color: #fee2e2; color: #991b1b; border: 1px solid #dc3545; }
  .status-ok { background-color: #d1fae5; color: #065f46; }
  .status-process { background-color: #dbeafe; color: #1e40af; }

  .date-warning { color: #d97706; font-weight: bold; font-size: 11px; }
  .date-expired { color: #dc3545; font-weight: bold; font-size: 11px; }

  .next-step-badge { display: inline-block; font-size: 11px; color: #555; background: #eee; padding: 2px 6px; border-radius: 4px; border-left: 3px solid #666; max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  .action-btn { background: none; border: none; cursor: pointer; padding: 6px; font-size: 15px; border-radius: 4px; transition: all 0.2s; }
  .action-btn:hover { background-color: rgba(0,0,0,0.05); }
  .btn-edit { color: #007bff; } 
  .btn-del { color: #dc3545; } 
  .btn-print { color: #666; }

  /* --- MODAL --- */
  .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.2s; }
  .modal-overlay.open { display: flex; opacity: 1; }
  .modal-content { background: var(--cc-bg-modal); padding: 0; border-radius: 12px; width: 95%; max-width: 1100px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 15px 50px rgba(0,0,0,0.3); border: 1px solid var(--cc-border); }
  .modal-header { padding: 15px 25px; border-bottom: 1px solid var(--cc-border); display: flex; justify-content: space-between; align-items: center; background: var(--cc-gray); border-radius: 12px 12px 0 0; }
  .modal-body { padding: 25px; overflow-y: auto; flex: 1; }
  .modal-footer { padding: 15px 25px; border-top: 1px solid var(--cc-border); display: flex; justify-content: space-between; background: var(--cc-gray); border-radius: 0 0 12px 12px; }

  .form-section-title { grid-column: span 4; border-top: 2px solid var(--cc-border); margin-top: 15px; padding-top: 10px; color: var(--cc-red); font-weight: bold; font-size: 13px; text-transform: uppercase; }
  .form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
  .form-group { margin-bottom: 5px; }
  .form-group label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 11px; color: var(--cc-text-muted); }
  .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid var(--cc-border); border-radius: 4px; font-size: 12px; background: var(--cc-white); color: var(--cc-black); }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--cc-red); box-shadow: 0 0 0 2px rgba(228, 0, 43, 0.1); }
  .form-group input[type="date"] { min-height: 36px; }
  .form-group textarea { resize: vertical; min-height: 80px; }

  .required label::after { content: " *"; color: var(--color-danger); }

  /* --- DOCUMENT UPLOAD --- */
  .upload-area { border: 1px dashed var(--cc-border); border-radius: 4px; padding: 15px; text-align: center; margin-top: 10px; cursor: pointer; transition: all 0.2s; }
  .upload-area:hover { border-color: var(--cc-red); background-color: rgba(228, 0, 43, 0.05); }
  .document-list { margin-top: 10px; max-height: 200px; overflow-y: auto; }
  .document-item { display: flex; align-items: center; justify-content: space-between; padding: 8px; background: var(--cc-gray); border-radius: 4px; margin-bottom: 5px; }
  .document-name { font-size: 12px; display: flex; align-items: center; gap: 8px; flex: 1; }
  .document-date { font-size: 10px; color: var(--cc-text-muted); }
  .document-actions { display: flex; gap: 5px; }

  /* --- PROFESSIONAL REPORT STYLES (PDF/PRINT) --- */
  #printArea { display: none; }

  .report-header { text-align: center; border-bottom: 3px solid var(--cc-red); padding-bottom: 20px; margin-bottom: 30px; display: flex; align-items: center; justify-content: center; gap: 20px; }
  .report-logo { width: 80px; height: 80px; background: var(--cc-red); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; color: white; }
  .report-title h2 { margin: 0; color: #333; font-size: 24px; }
  .report-title p { margin: 5px 0 0; color: #666; font-size: 14px; }

  .report-section { margin-bottom: 25px; }
  .report-section h3 { font-size: 16px; color: var(--cc-red); border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-top: 0; margin-bottom: 10px; }
  .report-table { width: 100%; border-collapse: collapse; border: 1px solid #ddd; }
  .report-table th, .report-table td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 13px; }
  .report-table th { background-color: #f9f9f9; color: #333; }

  .status-stamp { 
    width: 180px; height: 180px; border: 5px solid #28a745; color: #28a745; 
    border-radius: 50%; display: flex; align-items: center; justify-content: center; 
    font-weight: 900; font-size: 24px; transform: rotate(-15deg); opacity: 0.2; margin-top: 20px;
  }
  .signature-area { margin-top: 80px; display: flex; justify-content: space-between; }
  .sign-box { width: 40%; border-top: 2px solid #000; padding-top: 10px; text-align: center; font-size: 14px; color: #333; font-weight: bold;}

  @media print {
    body { margin: 0; background: white; }
    header, .controls, .dashboard, .table-container, .modal-overlay, .toast { display: none !important; }
    #printArea {
      display: block !important;
      position: absolute;
      top: 0; left: 0; width: 100%;
      background: white; color: black; padding: 40px; z-index: 99999;
    }
    .no-print { display: none; }
    .status-stamp { opacity: 1; border-width: 5px; }
    .report-header, .report-section { page-break-inside: avoid; }
  }

  .toast { visibility: hidden; min-width: 280px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 14px 24px; position: fixed; z-index: 2000; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px); box-shadow: 0 5px 20px rgba(0,0,0,0.3); font-size: 14px; opacity: 0; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
  .toast.show { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); }
  .toast.success { background-color: #28a745; }
  .toast.error { background-color: #dc3545; }
  .toast.warning { background-color: #f59e0b; color: #000; }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--cc-text-muted);
  }
  .empty-state i {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.5;
  }

  /* Loading */
  .loading { display: none; text-align: center; padding: 20px; }
  .spinner { border: 3px solid var(--cc-gray); border-top: 3px solid var(--cc-red); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  /* Responsive */
  @media (max-width: 768px) {
    .form-grid { grid-template-columns: repeat(2, 1fr); }
    .form-section-title { grid-column: span 2; }
    .controls { flex-direction: column; align-items: stretch; }
    .search-wrapper, select { width: 100%; margin-bottom: 10px; }
    .dashboard { grid-template-columns: repeat(2, 1fr); }
  }

  @media (max-width: 480px) {
    .form-grid { grid-template-columns: 1fr; }
    .form-section-title { grid-column: span 1; }
    .dashboard { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- Header -->
<header>
  <div class="logo-area">
    <div class="chef-icon">üë®‚Äçüç≥</div>
    <div class="app-title">
      <h1>CRISPY CHICKEN HR</h1>
      <span>Compliance & Onboarding Tracker</span>
    </div>
  </div>
  <div class="header-actions">
    <button class="header-btn" title="Toggle Dark Mode" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
    <!-- Notifications Button with Badge -->
    <button class="header-btn" title="Daily Alerts & 15-Day Warning" onclick="showNotifications()">
      <i class="fas fa-bell"></i>
      <span id="notifCount" class="badge-notify">0</span>
    </button>
  </div>
</header>

<!-- Controls -->
<div class="controls">
  <div class="search-wrapper">
    <span class="search-icon">üîç</span>
    <input type="text" id="searchInput" placeholder="Search ID, Name..." onkeyup="filterData()" />
  </div>
  <div style="flex:1"></div>
  <select id="typeFilter" onchange="filterData()" style="padding:8px; border-radius:4px; border:1px solid #ccc;">
    <option value="">All Staff</option>
    <option value="new">üîµ New Staff (Onboarding)</option>
    <option value="existing">üü¢ Existing Staff</option>
    <option value="alert">üü† Needs Attention</option>
  </select>
  <button class="btn-export" onclick="exportToCSV()"><i class="fas fa-download"></i> Excel</button>
  <button class="btn-add" onclick="openAddModal()"><i class="fas fa-plus"></i> New Staff</button>
</div>

<!-- Stats -->
<div class="dashboard">
  <div class="stat-card stat-total">
    <div class="stat-number" id="totalCount">0</div>
    <div class="stat-label">Total Staff</div>
  </div>
  <div class="stat-card stat-new">
    <div class="stat-number" id="newCount" style="color: #3b82f6;">0</div>
    <div class="stat-label">Onboarding</div>
  </div>
  <div class="stat-card stat-active">
    <div class="stat-number" id="activeCount" style="color: #10b981;">0</div>
    <div class="stat-label">Active / Handed Over</div>
  </div>
  <div class="stat-card stat-alert">
    <div class="stat-number" id="alertCount" style="color: #f59e0b;">0</div>
    <div class="stat-label">Action Required</div>
  </div>
</div>

<!-- Table -->
<div class="table-container">
  <div class="table-header">
    <div style="font-weight:bold;">Employee Directory & Follow-ups</div>
    <div style="font-size:12px; color:var(--cc-text-muted);" id="tableCount">Showing 0 employees</div>
  </div>
  <div class="loading" id="tableLoading">
    <div class="spinner"></div>
    <p>Loading data...</p>
  </div>
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th style="width: 60px;">Sts</th>
          <th style="width: 80px;">ID</th>
          <th>Name</th>
          <th>Next Step / Follow Up</th>
          <th>Branch</th>
          <th style="width: 180px;">Expiry Alerts (Passport/Visa)</th>
          <th>Status</th>
          <th style="width: 120px;">Actions</th>
        </tr>
      </thead>
      <tbody id="employeeTableBody"></tbody>
    </table>
  </div>
</div>

<!-- MAIN MODAL: ADD/EDIT -->
<div id="staffModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle" style="margin:0;">Staff Details</h3>
      <button class="action-btn" onclick="closeModal('staffModal')">&times;</button>
    </div>
    <div class="modal-body">
      <!-- Form contents omitted for brevity (see previous full code) -->
      <!-- You should include the form as in the previous code snippet, same as before -->
    </div>
    <div class="modal-footer">
      <button class="btn-reset" style="background:#999;" onclick="closeModal('staffModal')">Cancel</button>
      <button class="btn-add" onclick="saveStaff()"><i class="fas fa-save"></i> Save Record</button>
    </div>
  </div>
</div>

<!-- NOTIFICATIONS MODAL -->
<div id="notificationsModal" class="modal-overlay">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h3 style="margin:0;">üì¢ Notifications & Alerts</h3>
      <button class="action-btn" onclick="closeModal('notificationsModal')">&times;</button>
    </div>
    <div class="modal-body" style="max-height: 70vh; overflow-y:auto;">
      <div id="notificationsList"></div>
    </div>
  </div>
</div>

<!-- Hidden Print Area for Professional Report -->
<div id="printArea"> ... </div> <!-- same as previous code, omitted for brevity -->

<!-- Toast Notification -->
<div id="toast" class="toast">
  <i class="fas fa-check-circle"></i>
  <span>Saved Successfully</span>
</div>

<script>
  // --- Data & State ---
  const STORAGE_KEY = 'crispy_chicken_hr_system_v2.1';
  let employees = [];
  let filteredEmployees = [];
  let documents = [];
  let documentsExisting = [];

  // --- Initialization ---
  document.addEventListener('DOMContentLoaded', () => {
    // Load theme
    const savedTheme = localStorage.getItem('cc_hr_theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);

    loadData();
    setTodayDate();
    initializeDateInputs();

    // Auto-refresh notifications
    setInterval(updateNotifications, 60000); // every 60 sec
    updateUI();
    updateNotifications(); // initial
  });

  // --- Load & Save Data ---
  function loadData() {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
      try { employees = JSON.parse(stored); } catch (e) { employees = []; }
    }
    if (employees.length === 0) {
      employees = getSampleData();
      saveData();
    }
    updateUI();
  }

  function saveData() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(employees));
    updateUI();
    updateNotifications();
  }

  // --- Sample Data ---
  function getSampleData() {
    return [
      { id: "CC001", name: "Mohamed Ahmed", staffType: "existing", nationality: "Egyptian", designation: "Restaurant Manager", branch: "CC Hamdan St", passportExp: "2025-06-30", visaExp: "2024-12-31", medExpMain: "2024-12-31", lastUpdated: new Date().toISOString(), documents: [] },
      { id: "CC002", name: "Fatima Khan", staffType: "new", nationality: "Bangladeshi", designation: "Cashier", branch: "CC Khaldia", hireDate: "2024-02-01", entryIssued: "2024-02-05", entryConfirmed: "2024-02-07", dateEntry: "2024-02-10", mohreOffer: "2024-02-15", laborContract: "2024-02-17", laborSigned: "2024-02-18", medResult: "2024-02-20", medInsurance: "2024-02-22", eidRec: "2024-03-01", visaIssued: "2024-03-05", visaStamped: "2024-03-07", bankAccount: "2024-03-10", itSetup: "Done", adminSetup: "Done", orientation: "Done", lastUpdated: new Date().toISOString(), documents: [{id:1,name:"Passport Copy",date:"2024-02-01",size:1024},{id:2,name:"Medical Report",date:"2024-02-20",size:2048}] },
      { id: "CC003", name: "John Smith", staffType: "existing", nationality: "Indian", designation: "Chef", branch: "CC Muroor", passportExp: "2024-03-01", visaExp: "2024-06-15", medExpMain: "2024-05-20", lastUpdated: new Date().toISOString(), documents: [] }
    ];
  }

  // --- UI & Rendering ---
  function updateUI() {
    const tbody = document.getElementById('employeeTableBody');
    const tableCount = document.getElementById('tableCount');
    const loading = document.getElementById('tableLoading');

    tbody.innerHTML = '';
    filterData();
    loading.style.display = 'block';

    setTimeout(() => {
      loading.style.display = 'none';

      if (filteredEmployees.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" class="empty-state">
          <i class="fas fa-users"></i>
          <h3>No employees found</h3>
          <p>Add your first employee using the "Add Staff" button</p>
        </td></tr>`;
        tableCount.innerText = `Showing 0 employees`;
        document.getElementById('notifCount').style.display = 'none';
        return;
      }

      let countNew=0, countActive=0, countAlert=0, notifCount=0;

      filteredEmployees.forEach(emp => {
        const status = getOverallStatus(emp);
        if (emp.staffType==='new') countNew++;
        if (status.category==='active' || status.category==='ready') countActive++;
        if (status.category==='warning' || status.category==='expired') { countAlert++; notifCount++; }

        if (emp.staffType==='new' && status.category==='process') notifCount++;

        // Build row
        const tr = document.createElement('tr');
        if (status.category==='warning' || status.category==='expired') tr.className='alert-row';
        if (emp.staffType==='new') tr.className='new-staff-row';

        const expiryHTML = emp.staffType==='existing' ? 
          `<div><small>Pass:</small> <span class="${getExpiryStatus(emp.passportExp).class}">${getExpiryStatus(emp.passportExp).label}</span></div>
           <div style="margin-top:2px;"><small>Visa:</small> <span class="${getExpiryStatus(emp.visaExp||emp.visaExpExisting).class}">${getExpiryStatus(emp.visaExp||emp.visaExpExisting).label}</span></div>` : 
          `<span style="color:#aaa;">-</span>`;

        const nextStep = emp.staffType==='new' ? `<span class="next-step-badge" title="${getNextStep(emp).step}">${getNextStep(emp).step}</span>` : `<span class="next-step-badge" style="border-left-color:#ccc">Routine Monitoring</span>`;

        tr.innerHTML=`
          <td><span class="badge ${status.class}">${emp.staffType==='new'?'NEW':'EXS'}</span></td>
          <td><strong>${emp.id}</strong></td>
          <td>
            <div style="font-weight:600;">${emp.name}</div>
            <small style="color:#888">${emp.designation||''} ‚Ä¢ ${emp.nationality||''}</small>
          </td>
          <td>${nextStep}</td>
          <td>${emp.branch}</td>
          <td>${expiryHTML}</td>
          <td><span style="font-weight:bold; color:${status.color}">${status.label}</span></td>
          <td>
            <button class="action-btn btn-edit" onclick="editEmployee('${emp.id}')" title="Edit"><i class="fas fa-edit"></i></button>
            <button class="action-btn btn-print" onclick="printReport('${emp.id}')" title="Print"><i class="fas fa-print"></i></button>
            <button class="action-btn btn-del" onclick="deleteEmployee('${emp.id}')" title="Delete"><i class="fas fa-trash"></i></button>
          </td>`;
        tbody.appendChild(tr);
      });

      // Counters
      document.getElementById('totalCount').innerText=employees.length;
      document.getElementById('newCount').innerText=countNew;
      document.getElementById('activeCount').innerText=countActive;
      document.getElementById('alertCount').innerText=countAlert;

      // Notifications badge
      const notifBadge = document.getElementById('notifCount');
      if (notifCount>0) {
        notifBadge.innerText=notifCount;
        notifBadge.style.display='block';
      } else {
        notifBadge.style.display='none';
      }
      document.getElementById('tableCount').innerText=`Showing ${filteredEmployees.length} of ${employees.length} employees`;

    }, 300);
  }

  // --- Filter ---
  function filterData() {
    const term = document.getElementById('searchInput').value.toLowerCase();
    const filterType=document.getElementById('typeFilter').value;
    filteredEmployees=employees.filter(emp => {
      const matchSearch=!term || emp.id.toLowerCase().includes(term) || emp.name.toLowerCase().includes(term) || (emp.designation && emp.designation.toLowerCase().includes(term)) || (emp.branch && emp.branch.toLowerCase().includes(term));
      let matchType=true;
      if (filterType==='new') matchType=emp.staffType==='new';
      else if (filterType==='existing') matchType=emp.staffType==='existing';
      else if (filterType==='alert') {
        const status=getOverallStatus(emp);
        matchType=status.category==='warning'||status.category==='expired'||(emp.staffType==='new'&&status.category==='process');
      }
      return matchSearch && matchType;
    });
  }

  // --- Utility functions ---
  function getExpiryStatus(dateStr) {
    if (!dateStr) return { label: '-', class: '', warning: false, urgent: false, daysLeft: null };
    const today=new Date(); today.setHours(0,0,0,0);
    const target=new Date(dateStr); target.setHours(0,0,0,0);
    const diff=Math.ceil((target - today)/(1000*60*60*24));
    if (diff<=0) return { label: 'EXPIRED', class:'date-expired', warning:false, urgent:true, daysLeft:0 };
    if (diff<=15) return { label: `${diff} Days Left`, class:'date-warning', warning:true, urgent:false, daysLeft:diff };
    return { label: `${diff} Days`, class:'', warning:false, urgent:false, daysLeft:diff };
  }

  function getOverallStatus(emp) {
    if (emp.staffType==='new') {
      const step=getNextStep(emp);
      if (step.step==="Ready for Handover") {
        return { label:"‚úÖ Ready", class:"status-ok", color:"#10b981", category:"ready" };
      } else {
        return { label:"‚öôÔ∏è In Process", class:"status-process", color:"#3b82f6", category:"process" };
      }
    } else {
      // existing staff
      const pass=getExpiryStatus(emp.passportExp);
      const visa=getExpiryStatus(emp.visaExp||emp.visaExpExisting);
      const med=getExpiryStatus(emp.medExpMain);
      if (pass.urgent || visa.urgent || med.urgent) {
        return { label:"üî¥ Expired", class:"status-expired", color:"#dc3545", category:"expired" };
      }
      if (pass.warning || visa.warning || med.warning) {
        return { label:"üü† Expiring Soon", class:"status-warning", color:"#f59e0b", category:"warning" };
      }
      return { label:"‚úÖ Active", class:"status-ok", color:"#10b981", category:"active" };
    }
  }

  function getNextStep(emp) {
    if (emp.staffType!=='new') return { step:"Routine Monitoring" };
    if (!emp.hireDate) return { step:"Approve Hire Date" };
    if (!emp.entryIssued) return { step:"Issue Entry Permit" };
    if (!emp.entryConfirmed) return { step:"Confirm Entry Permit Received" };
    if (!emp.dateEntry) return { step:"Record Entry Date" };
    if (!emp.laborContract) return { step:"Prepare & Sign Labor Contract" };
    if (!emp.medResult) return { step:"Schedule Medical / Get Result" };
    if (!emp.medInsurance) return { step:"Activate Medical Insurance" };
    if (!emp.eidRec) return { step:"Wait for EID Delivery" };
    if (!emp.visaIssued) return { step:"Issue Visa" };
    if (!emp.visaStamped) return { step:"Stamp Visa in Passport" };
    if (!emp.bankAccount) return { step:"Open Bank Account" };
    if (!emp.branchStartDate) return { step:"Send to Restaurant (Handover)" };
    return { step:"Ready for Handover" };
  }

  // --- Modal functions ---
  function openModal(id) {
    document.getElementById(id).classList.add('open');
    document.body.style.overflow='hidden';
  }
  function closeModal(id) {
    document.getElementById(id).classList.remove('open');
    document.body.style.overflow='';
  }

  // --- Notifications ---
  function updateNotifications() {
    const today=new Date();
    let notifCount=0;
    const notifications=[];

    employees.forEach(emp => {
      const status = getOverallStatus(emp);
      if (status.category==='expired') {
        notifications.push({ type:'error', message:`${emp.name} (${emp.id}) - Documents Expired`, employeeId:emp.id });
        notifCount++;
      } else if (status.category==='warning') {
        const pass=getExpiryStatus(emp.passportExp);
        const visa=getExpiryStatus(emp.visaExp||emp.visaExpExisting);
        const med=getExpiryStatus(emp.medExpMain);
        let expiringItem='Documents';
        if (pass.warning) expiringItem='Passport';
        else if (visa.warning) expiringItem='Visa';
        else if (med.warning) expiringItem='Medical Insurance';

        notifications.push({ type:'warning', message:`${emp.name} (${emp.id}) - ${expiringItem} expiring in ${pass.daysLeft || visa.daysLeft || med.daysLeft} days`, employeeId:emp.id });
        notifCount++;
      } else if (emp.staffType==='new' && status.category==='process') {
        const step=getNextStep(emp);
        notifications.push({ type:'info', message:`${emp.name} (${emp.id}) - ${step.step}`, employeeId:emp.id });
        notifCount++;
      }
      // Overdue Entry Permit confirmation
      if (emp.staffType==='new' && emp.entryIssued && !emp.entryConfirmed) {
        const issued=new Date(emp.entryIssued);
        const diffDays=Math.floor((today-issued)/(1000*60*60*24));
        if (diffDays>60) {
          notifications.push({ type:'warning', message:`${emp.name} (${emp.id}) - Entry Permit confirmation overdue (${diffDays} days)`, employeeId:emp.id });
          notifCount++;
        }
      }
    });
    // Show notifications
    const listEl=document.getElementById('notificationsList');
    if (notifications.length===0) {
      listEl.innerHTML=`<div class="empty-state"><i class="fas fa-bell-slash"></i><h3>No alerts</h3><p>All employees are up to date</p></div>`;
    } else {
      let html=`<div style="display:flex; flex-direction:column; gap:10px;">`;
      notifications.forEach(n => {
        const icon=n.type==='error'?'üî¥':n.type==='warning'?'üü†':'üîµ';
        html+=`
        <div style="padding:12px; background:${n.type==='error'?'#fee':n.type==='warning'?'#ffd':'#eef'}; border-radius:6px; border-left:4px solid ${n.type==='error'?'#dc3545':n.type==='warning'?'#f59e0b':'#3b82f6'};">
          <div style="display:flex; align-items:center; gap:10px;">
            <span style="font-size:18px;">${icon}</span>
            <div style="flex:1;">
              <div style="font-weight:600; font-size:13px;">${n.message}</div>
              <small style="color:#666; font-size:11px;">Click arrow to view</small>
            </div>
            <button class="action-btn btn-edit" onclick="editEmployee('${n.employeeId}'); closeModal('notificationsModal')"><i class="fas fa-arrow-right"></i></button>
          </div>
        </div>`;
      });
      html+=`</div>`;
      listEl.innerHTML=html;
    }
  }
  function showNotifications() {
    updateNotifications();
    openModal('notificationsModal');
  }

  // --- Print report ---
  function printReport(id) {
    const emp=employees.find(e=>e.id===id);
    if (!emp) { showToast('Employee not found','error'); return; }
    populateReport(emp);
    window.print();
  }

  // --- Toast ---
  function showToast(msg, type='success') {
    const toast=document.getElementById('toast');
    toast.innerHTML=`<i class="fas fa-${type==='success'?'check-circle':type==='error'?'exclamation-circle':'exclamation-triangle'}"></i> ${msg}`;
    toast.className=`toast ${type} show`;
    setTimeout(()=>{ toast.className=toast.className.replace('show',''); },3000);
  }

  // --- Toggle theme ---
  function toggleTheme() {
    const current=document.documentElement.getAttribute('data-theme');
    const newTheme=current==='dark'?'light':'dark';
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('cc_hr_theme', newTheme);
  }

  // --- Utility ---
  function formatDate(dateStr) {
    if (!dateStr) return '';
    const d=new Date(dateStr);
    return d.toLocaleDateString('en-GB',{ day:'2-digit', month:'short', year:'numeric' });
  }

  // --- Modal handlers ---
  document.querySelectorAll('.modal-overlay').forEach(mod => {
    document.addEventListener('keydown', e => { if(e.key==='Escape') { mod.classList.remove('open'); document.body.style.overflow=''; } });
    document.addEventListener('click', e => { if(e.target===mod) { mod.classList.remove('open'); document.body.style.overflow=''; } });
  });
  function openModal(id) {
    document.getElementById(id).classList.add('open');
    document.body.style.overflow='hidden';
  }
  function closeModal(id) {
    document.getElementById(id).classList.remove('open');
    document.body.style.overflow='';
  }

  // --- Save Staff ---
  function saveStaff() {
    const empId=document.getElementById('inpId').value.trim();
    const empName=document.getElementById('inpName').value.trim();
    if (!empId || !empName) { showToast('ID and Name are required','error'); return; }
    const isNew=document.getElementById('editId').value==='';

    if (isNew && employees.some(e=>e.id===empId)) {
      showToast('Employee ID already exists','error');
      document.getElementById('inpId').focus();
      return;
    }

    const data=gatherFormData();

    if (isNew) {
      employees.unshift({ ...data, lastUpdated:new Date().toISOString() });
    } else {
      const idx=employees.findIndex(e=>e.id===document.getElementById('editId').value);
      if (idx!==-1) {
        employees[idx]={ ...employees[idx], ...data, lastUpdated:new Date().toISOString() };
      }
    }
    saveData();
    closeModal('staffModal');
    showToast(`Employee ${isNew?'added':'updated'} successfully`,'success');
  }

  function gatherFormData() {
    const data={};
    // Map fields
    const fieldMap={
      'inpStaffType':'staffType',
      'inpId':'id',
      'inpName':'name',
      'inpNationality':'nationality',
      'inpDesignation':'designation',
      'inpBranch':'branch',
      'inpHireDate':'hireDate',
      'inpEntryIssued':'entryIssued',
      'inpEntryConfirmed':'entryConfirmed',
      'inpDateEntry':'dateEntry',
      'inpMohreOffer':'mohreOffer',
      'inpLaborContract':'laborContract',
      'inpLaborSigned':'laborSigned',
      'inpMedResult':'medResult',
      'inpMedInsurance':'medInsurance',
      'inpEidRec':'eidRec',
      'inpVisaIssued':'visaIssued',
      'inpVisaStamped':'visaStamped',
      'inpBankAccount':'bankAccount',
      'inpBranchStart':'branchStartDate',
      'inpNotes':'notes',
      'inpPassportNo':'passportNo',
      'inpPassportExp':'passportExp',
      'inpMedExpMain':'medExpMain',
      'inpVisaExpExisting':'visaExpExisting',
      'inpLaborCardExp':'laborCardExp',
      'inpEidExp':'eidExp',
      'inpNotesExisting':'notesExisting'
    };
    for (const [inputId, field] of Object.entries(fieldMap)) {
      const el=document.getElementById(inputId);
      if (el) data[field]=el.value;
    }
    // Documents
    data.documents=(data.staffType==='new')? [...documents]: [...documentsExisting];
    return data;
  }

  // --- Delete ---
  function deleteEmployee(id) {
    if (confirm(`Are you sure you want to delete employee ${id}?`)) {
      employees=employees.filter(e=>e.id!==id);
      saveData();
      showToast('Deleted successfully','success');
    }
  }

  // --- Print ---
  function printReport(id) {
    const emp=employees.find(e=>e.id===id);
    if (!emp) { showToast('Employee not found','error'); return; }
    populateReport(emp);
    window.print();
  }

  // --- Populate Report ---
  function populateReport(emp) {
    document.getElementById('prName').innerText=emp.name;
    document.getElementById('prId').innerText=emp.id;
    document.getElementById('prDesignation').innerText=emp.designation || '-';
    document.getElementById('prBranch').innerText=emp.branch;
    const status=getOverallStatus(emp);
    document.getElementById('prStatus').innerText=status.label;
    document.getElementById('prStage').innerText=emp.staffType==='new'?'Onboarding':'Employed';

    const chk=(val)=>val?formatDate(val):'‚ùå Pending';
    document.getElementById('prEntry').innerText=chk(emp.entryIssued);
    document.getElementById('prMedical').innerText=chk(emp.medResult);
    document.getElementById('prEID').innerText=chk(emp.eidRec);
    document.getElementById('prVisa').innerText=chk(emp.visaIssued);
    document.getElementById('prPassExp').innerText=emp.passportExp||'-';
    document.getElementById('prVisaExp').innerText=emp.visaExp||emp.visaExpExisting||'-';

    // Timeline
    const timeline=document.getElementById('onboardingTimeline');
    let html='';
    const steps=[
      { name:'Hire Approval', date:emp.hireDate },
      { name:'Entry Permit Issued', date:emp.entryIssued },
      { name:'Entry Permit Confirmed', date:emp.entryConfirmed },
      { name:'Date of Entry', date:emp.dateEntry },
      { name:'Labor Contract', date:emp.laborSigned },
      { name:'Medical Result', date:emp.medResult },
      { name:'Medical Insurance', date:emp.medInsurance },
      { name:'EID Received', date:emp.eidRec },
      { name:'Visa Issued', date:emp.visaIssued },
      { name:'Visa Stamped', date:emp.visaStamped },
      { name:'Bank Account', date:emp.bankAccount },
      { name:'Branch Handover', date:emp.branchStartDate }
    ];
    steps.forEach((step,i)=>{
      if (step.date) {
        const prevDate=new Date(i>0?steps[i-1].date:null);
        const currDate=new Date(step.date);
        const days=prevDate?Math.ceil((currDate-prevDate)/(1000*60*60*24)):'-';
        html+=`
        <tr>
          <td>${step.name}</td>
          <td>-</td>
          <td>${formatDate(step.date)}</td>
          <td>${days}</td>
          <td>${getStepResponsible(step.name)}</td>
        </tr>`;
      }
    });
    document.getElementById('onboardingTimeline').innerHTML=html;

    // Actions
    const actions=[];
    if (emp.hireDate) actions.push(`Hire Approved on ${formatDate(emp.hireDate)}`);
    if (emp.entryIssued) actions.push(`Entry Permit Issued: ${formatDate(emp.entryIssued)}`);
    if (emp.entryConfirmed) actions.push(`Entry Confirmed: ${formatDate(emp.entryConfirmed)}`);
    if (emp.dateEntry) actions.push(`Date of Entry: ${formatDate(emp.dateEntry)}`);
    if (emp.laborContract) actions.push(`Labor Contract: ${formatDate(emp.laborContract)}`);
    if (emp.laborSigned) actions.push(`Labor Signed: ${formatDate(emp.laborSigned)}`);
    if (emp.medResult) actions.push(`Medical: ${formatDate(emp.medResult)}`);
    if (emp.medInsurance) actions.push(`Medical Insurance: ${formatDate(emp.medInsurance)}`);
    if (emp.eidRec) actions.push(`EID: ${formatDate(emp.eidRec)}`);
    if (emp.visaIssued) actions.push(`Visa: ${formatDate(emp.visaIssued)}`);
    if (emp.visaStamped) actions.push(`Visa Stamped: ${formatDate(emp.visaStamped)}`);
    if (emp.bankAccount) actions.push(`Bank: ${formatDate(emp.bankAccount)}`);
    if (emp.branchStartDate) actions.push(`Handover: ${formatDate(emp.branchStartDate)}`);
    if (emp.notes) actions.push(`Notes: ${emp.notes}`);
    document.getElementById('prActions').innerHTML=actions.length?actions.map(li=>`<li>${li}</li>`).join(''):'<li>No actions recorded</li>';

    // Stamp
    const stamp=document.getElementById('prStamp');
    stamp.style.display=status.label.includes('Ready')?'flex':'none';
  }

</script>
</body>
</html>
