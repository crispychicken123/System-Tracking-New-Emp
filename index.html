<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Crispy Chicken - HR & Compliance System</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
  /* --- CSS VARIABLES --- */
  :root {
    --cc-red: #E4002B;
    --cc-black: #1a1a1a;
    --cc-white: #ffffff;
    --cc-gray: #f4f6f9;
    --cc-border: #e0e0e0;
    --cc-text-muted: #666;
    --cc-bg-modal: #ffffff;
    --cc-table-hover: rgba(0,0,0,0.02);
    --color-warning: #f59e0b;
    --color-danger: #dc3545;
    --color-success: #10b981;
    --color-info: #3b82f6;
  }
  [data-theme="dark"] {
    --cc-black: #f0f0f0;
    --cc-white: #1e1e1e;
    --cc-gray: #252526;
    --cc-border: #333;
    --cc-text-muted: #aaa;
    --cc-bg-modal: #2d2d2d;
    --cc-table-hover: rgba(255,255,255,0.05);
  }
  * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--cc-gray);
    margin: 0;
    padding: 0;
    color: var(--cc-black);
    transition: background-color 0.3s, color 0.3s;
    min-height: 100vh;
  }

  /* --- HEADER --- */
  header {
    background-color: var(--cc-white); color: var(--cc-black);
    padding: 12px 24px; display: flex; align-items: center; justify-content: space-between;
    border-bottom: 4px solid var(--cc-red); position: sticky; top: 0; z-index: 100;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }
  .logo-area { display: flex; align-items: center; gap: 12px; }
  .chef-icon { font-size: 28px; background: var(--cc-red); color: white; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; }
  .app-title h1 { margin: 0; font-size: 18px; font-weight: 700; }
  .app-title span { font-size: 11px; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; }

  .header-actions { display: flex; gap: 15px; align-items: center; position: relative; }
  .header-btn { background: none; border: none; font-size: 16px; cursor: pointer; color: var(--cc-text-muted); transition: color 0.2s; position: relative; padding: 8px; }
  .header-btn:hover { color: var(--cc-black); }
  .badge-notify { position: absolute; top: -5px; right: -5px; background: var(--color-danger); color: white; font-size: 10px; padding: 2px 5px; border-radius: 10px; display: none; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

  /* --- Controls --- */
  .controls { padding: 15px 24px; background: var(--cc-white); display: flex; gap: 12px; align-items: center; border-bottom: 1px solid var(--cc-border); flex-wrap: wrap; }
  .search-wrapper { flex: 1; min-width: 200px; position: relative; }
  .search-wrapper input { width: 100%; padding: 10px 10px 10px 35px; border: 1px solid var(--cc-border); border-radius: 20px; font-size: 14px; background-color: var(--cc-gray); color: var(--cc-black); }
  .search-wrapper input:focus { border-color: var(--cc-red); }
  .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #888; }

  button { padding: 9px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; color: white; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s; }
  button:hover { opacity: 0.9; transform: translateY(-1px); }
  .btn-add { background-color: var(--cc-red); }
  .btn-export { background-color: #28a745; }
  .btn-print { background-color: #6c757d; }

  /* --- Dashboard --- */
  .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; padding: 20px 24px 0 24px; }
  .stat-card { background: var(--cc-white); padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.03); border-top: 4px solid transparent; display: flex; flex-direction: column; align-items: center; }
  .stat-number { font-size: 28px; font-weight: 800; color: var(--cc-black); margin-bottom: 2px; }
  .stat-label { font-size: 11px; font-weight: 600; color: var(--cc-text-muted); text-transform: uppercase; }
  
  .stat-total { border-color: #666; } .stat-new { border-color: #3b82f6; } 
  .stat-active { border-color: #10b981; } .stat-alert { border-color: #f59e0b; }

  /* --- Table --- */
  .table-container { margin: 20px 24px 24px 24px; background: var(--cc-white); border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.03); border: 1px solid var(--cc-border); overflow: hidden; }
  .table-header { padding: 12px 20px; background: var(--cc-gray); border-bottom: 1px solid var(--cc-border); display: flex; justify-content: space-between; align-items: center; }
  .table-scroll { overflow-x: auto; max-height: calc(100vh - 260px); }
  table { width: 100%; border-collapse: collapse; min-width: 1800px; }
  th { background-color: var(--cc-gray); color: var(--cc-text-muted); font-weight: 700; font-size: 11px; text-transform: uppercase; padding: 12px 10px; text-align: left; border-bottom: 2px solid var(--cc-border); position: sticky; top: 0; z-index: 10; }
  td { padding: 10px; border-bottom: 1px solid var(--cc-border); font-size: 13px; color: var(--cc-black); vertical-align: middle; }
  tr:hover { background-color: var(--cc-table-hover); }
  tr.new-staff-row { background-color: rgba(59, 130, 246, 0.03); border-left: 3px solid #3b82f6; }
  tr.alert-row { background-color: rgba(245, 158, 11, 0.03); border-left: 3px solid #f59e0b; }

  /* Status & Badges */
  .badge { padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
  .status-warning { background-color: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
  .status-expired { background-color: #fee2e2; color: #991b1b; border: 1px solid #dc3545; }
  .status-ok { background-color: #d1fae5; color: #065f46; }
  .status-process { background-color: #dbeafe; color: #1e40af; }

  .date-warning { color: #d97706; font-weight: bold; font-size: 11px; }
  .date-expired { color: #dc3545; font-weight: bold; font-size: 11px; }

  .next-step-badge { display: inline-block; font-size: 11px; color: #555; background: #eee; padding: 2px 6px; border-radius: 4px; border-left: 3px solid #666; max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  .action-btn { background: none; border: none; cursor: pointer; padding: 6px; font-size: 15px; border-radius: 4px; transition: all 0.2s; }
  .action-btn:hover { background-color: rgba(0,0,0,0.05); }
  .btn-edit { color: #007bff; } 
  .btn-del { color: #dc3545; } 
  .btn-print { color: #666; }

  /* --- MODAL --- */
  .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.2s; }
  .modal-overlay.open { display: flex; opacity: 1; }
  .modal-content { background: var(--cc-bg-modal); padding: 0; border-radius: 12px; width: 95%; max-width: 1100px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 15px 50px rgba(0,0,0,0.3); border: 1px solid var(--cc-border); }
  .modal-header { padding: 15px 25px; border-bottom: 1px solid var(--cc-border); display: flex; justify-content: space-between; align-items: center; background: var(--cc-gray); border-radius: 12px 12px 0 0; }
  .modal-body { padding: 25px; overflow-y: auto; flex: 1; }
  .modal-footer { padding: 15px 25px; border-top: 1px solid var(--cc-border); display: flex; justify-content: space-between; background: var(--cc-gray); border-radius: 0 0 12px 12px; }

  /* --- Document Upload --- */
  .upload-area { border: 1px dashed var(--cc-border); border-radius: 4px; padding: 15px; text-align: center; margin-top: 10px; cursor: pointer; transition: all 0.2s; }
  .upload-area:hover { border-color: var(--cc-red); background-color: rgba(228, 0, 43, 0.05); }
  #documentList { margin-top: 10px; max-height: 200px; overflow-y: auto; }
  /* Document item styling */
  .document-item { display:flex; align-items:center; justify-content:space-between; padding:6px; background:#f4f4f4; margin-bottom:4px; border-radius:4px; font-size:12px; }
  .document-info { display:flex; align-items:center; gap:8px; }
  .document-name { font-weight:600; }
  /* Toast Notification */
  #toast { visibility: hidden; min-width: 280px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 14px 24px; position: fixed; z-index: 2000; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px); box-shadow: 0 5px 20px rgba(0,0,0,0.3); font-size: 14px; opacity: 0; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
  #toast.show { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); }
  /* Responsive */
  @media(max-width:768px){
    .form-grid { grid-template-columns: repeat(2, 1fr); }
  }
</style>
</head>
<body>

<!-- Header -->
<header>
  <div class="logo-area">
    <div class="chef-icon">üë®‚Äçüç≥</div>
    <div class="app-title">
      <h1>CRISPY CHICKEN HR</h1>
      <span>Compliance & Onboarding Tracker</span>
    </div>
  </div>
  <div class="header-actions">
    <button class="header-btn" title="Toggle Dark Mode" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
    <!-- Notifications Button with Badge -->
    <button class="header-btn" title="Daily Alerts & 15-Day Warning" onclick="showNotifications()">
      <i class="fas fa-bell"></i>
      <span id="notifCount" class="badge-notify">0</span>
    </button>
  </div>
</header>

<!-- Controls -->
<div class="controls">
  <div class="search-wrapper">
    <span class="search-icon">üîç</span>
    <input type="text" id="searchInput" placeholder="Search ID, Name..." onkeyup="filterData()" />
  </div>
  <div style="flex:1"></div>
  <select id="typeFilter" onchange="filterData()" style="padding:8px; border-radius:4px; border:1px solid #ccc;">
    <option value="">All Staff</option>
    <option value="new">üîµ New Staff (Onboarding)</option>
    <option value="existing">üü¢ Existing Staff</option>
    <option value="alert">üü† Needs Attention</option>
  </select>
  <button class="btn-export" onclick="exportToCSV()"><i class="fas fa-download"></i> Excel</button>
  <button class="btn-add" onclick="openAddModal()"><i class="fas fa-plus"></i> New Staff</button>
</div>

<!-- Stats -->
<div class="dashboard">
  <div class="stat-card stat-total">
    <div class="stat-number" id="totalCount">0</div>
    <div class="stat-label">Total Staff</div>
  </div>
  <div class="stat-card stat-new">
    <div class="stat-number" id="newCount" style="color: #3b82f6;">0</div>
    <div class="stat-label">Onboarding</div>
  </div>
  <div class="stat-card stat-active">
    <div class="stat-number" id="activeCount" style="color: #10b981;">0</div>
    <div class="stat-label">Active / Handed Over</div>
  </div>
  <div class="stat-card stat-alert">
    <div class="stat-number" id="alertCount" style="color: #f59e0b;">0</div>
    <div class="stat-label">Action Required</div>
  </div>
</div>

<!-- Table -->
<div class="table-container">
  <div class="table-header">
    <div style="font-weight:bold;">Employee Directory & Follow-ups</div>
    <div style="font-size:12px; color:var(--cc-text-muted);" id="tableCount">Showing 0 employees</div>
  </div>
  <div class="loading" id="tableLoading">
    <div class="spinner"></div>
    <p>Loading data...</p>
  </div>
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th style="width: 60px;">Sts</th>
          <th style="width: 80px;">ID</th>
          <th>Name</th>
          <th>Next Step / Follow Up</th>
          <th>Branch</th>
          <th style="width: 180px;">Expiry Alerts (Passport/Visa)</th>
          <th>Status</th>
          <th style="width: 120px;">Actions</th>
        </tr>
      </thead>
      <tbody id="employeeTableBody"></tbody>
    </table>
  </div>
</div>

<!-- MAIN MODAL: ADD/EDIT -->
<div id="staffModal" class="modal-overlay">
  <div class="modal-content" style="max-height:90vh; overflow-y:auto;">
    <div class="modal-header">
      <h3 id="modalTitle" style="margin:0;">Staff Details</h3>
      <button class="action-btn" onclick="closeModal('staffModal')">&times;</button>
    </div>
    <div class="modal-body" style="padding:15px;">
      <form id="staffForm" onsubmit="event.preventDefault(); saveStaff();">
        <!-- Basic Info -->
        <div class="form-grid">
          <div class="form-group required">
            <label for="inpStaffType">Staff Type</label>
            <select id="inpStaffType" required>
              <option value="existing">Existing</option>
              <option value="new">New Staff</option>
            </select>
          </div>
          <div class="form-group required">
            <label for="inpId">ID</label>
            <input type="text" id="inpId" required />
          </div>
          <div class="form-group required">
            <label for="inpName">Name</label>
            <input type="text" id="inpName" required />
          </div>
          <div class="form-group">
            <label for="inpNationality">Nationality</label>
            <input type="text" id="inpNationality" />
          </div>
          <div class="form-group">
            <label for="inpDesignation">Designation</label>
            <input type="text" id="inpDesignation" />
          </div>
          <div class="form-group">
            <label for="inpBranch">Branch</label>
            <input type="text" id="inpBranch" />
          </div>
        </div>
        <!-- Dates & Documents Upload -->
        <div class="form-grid" style="margin-top:15px;">
          <div class="form-group required">
            <label for="inpHireDate">Hire Date</label>
            <input type="date" id="inpHireDate" />
          </div>
          <div class="form-group">
            <label>Upload Documents</label>
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
              <i class="fas fa-upload"></i> Click to Upload Documents
              <input type="file" id="fileInput" multiple style="display:none" onchange="handleFileUpload(event)">
            </div>
            <div id="documentList"></div>
          </div>
        </div>
        <!-- Expiry Dates -->
        <div class="form-grid" style="margin-top:15px;">
          <div class="form-group">
            <label for="inpPassportExp">Passport Expiry</label>
            <input type="date" id="inpPassportExp" />
          </div>
          <div class="form-group">
            <label for="inpVisaExpExisting">Visa Expiry</label>
            <input type="date" id="inpVisaExpExisting" />
          </div>
        </div>
        <!-- Hidden -->
        <input type="hidden" id="editId" />
        <button type="submit" style="margin-top:15px; display:none;">Save</button>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn-reset" style="background:#999;" onclick="closeModal('staffModal')">Cancel</button>
      <button class="btn-add" onclick="saveStaff()"><i class="fas fa-save"></i> Save Record</button>
    </div>
  </div>
</div>

<!-- NOTIFICATIONS MODAL -->
<div id="notificationsModal" class="modal-overlay">
  <div class="modal-content" style="max-width:600px;">
    <div class="modal-header">
      <h3 style="margin:0;">üì¢ Notifications & Alerts</h3>
      <button class="action-btn" onclick="closeModal('notificationsModal')">&times;</button>
    </div>
    <div class="modal-body" style="max-height:70vh; overflow-y:auto;">
      <div id="notificationsList"></div>
    </div>
  </div>
</div>

<!-- PRINT AREA (for report) -->
<div id="printArea" style="display:none;"> ... </div>

<!-- Toast -->
<div id="toast" class="toast"><i class="fas fa-check-circle"></i> <span>Saved Successfully</span></div>

<script>
  // Data storage key
  const STORAGE_KEY='crispy_chicken_hr_system_v2.1';

  let employees=[]; // employee array
  let filteredEmployees=[]; // filtered list

  // Helper variables
  let currentEmployee=null;

  // Initialize
  document.addEventListener('DOMContentLoaded', ()=> {
    loadData();
    setTodayDate();
    updateUI();
    setInterval(updateNotifications,60000); // auto update notifications
    updateNotifications();
  });

  // Load data from local storage or sample data
  function loadData() {
    const stored=localStorage.getItem(STORAGE_KEY);
    if (stored) {
      try { employees=JSON.parse(stored); } catch(e){ employees=[]; }
    }
    if (employees.length===0) {
      employees=getSampleData();
      saveData();
    }
    filterData();
  }
  function saveData() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(employees));
    updateUI();
    updateNotifications();
  }

  function getSampleData() {
    return [
      { id:'CC001', name:'Mohamed Ahmed', staffType:'existing', nationality:'Egyptian', designation:'Restaurant Manager', branch:'CC Hamdan St', passportExp:'2025-06-30', visaExp:'2024-12-31', medExpMain:'2024-12-31', lastUpdated:new Date().toISOString(), documents:[] },
      { id:'CC002', name:'Fatima Khan', staffType:'new', nationality:'Bangladeshi', designation:'Cashier', branch:'CC Khaldia', hireDate:'2024-02-01', entryIssued:'2024-02-05', entryConfirmed:'2024-02-07', dateEntry:'2024-02-10', medResult:'2024-02-20', medInsurance:'2024-02-22', eidRec:'2024-03-01', visaIssued:'2024-03-05', visaStamped:'2024-03-07', bankAccount:'2024-03-10', notes:'', passportNo:'', passportExp:'2024-06-30', visaExpExisting:'2024-12-31', medExpMain:'2024-12-31', documents:[] }
    ];
  }

  // UI update
  function updateUI() {
    const tbody=document.getElementById('employeeTableBody');
    const tableCount=document.getElementById('tableCount');
    tbody.innerHTML='';
    filterData();
    document.getElementById('tableLoading').style.display='block';

    setTimeout(()=> {
      document.getElementById('tableLoading').style.display='none';

      if (filteredEmployees.length===0) {
        tbody.innerHTML=`<tr><td colspan="8" class="empty-state"><i class="fas fa-users"></i><h3>No employees found</h3><p>Add your first employee using the "Add Staff" button</p></td></tr>`;
        document.getElementById('notifCount').style.display='none';
        document.getElementById('tableCount').innerText=`Showing 0 employees`;
        return;
      }

      let countNew=0, countActive=0, countAlert=0, notifCount=0;

      filteredEmployees.forEach(emp=> {
        const status=getOverallStatus(emp);
        if (emp.staffType==='new') countNew++;
        if (status.category==='active'||status.category==='ready') countActive++;
        if (status.category==='warning'||status.category==='expired') { countAlert++; notifCount++; }

        if (emp.staffType==='new' && status.category==='process') notifCount++;

        const tr=document.createElement('tr');
        if (status.category==='warning'||status.category==='expired') tr.className='alert-row';
        if (emp.staffType==='new') tr.className='new-staff-row';

        const expiryHTML=emp.staffType==='existing' ? `
          <div><small>Pass:</small> <span class="${getExpiryStatus(emp.passportExp).class}">${getExpiryStatus(emp.passportExp).label}</span></div>
          <div style="margin-top:2px;"><small>Visa:</small> <span class="${getExpiryStatus(emp.visaExp||emp.visaExpExisting).class}">${getExpiryStatus(emp.visaExp||emp.visaExpExisting).label}</span></div>
        ` : `<span style="color:#aaa;">-</span>`;

        const nextStep=getNextStep(emp);
        const nextStepHTML=`<span class="next-step-badge" title="${nextStep.step}">${nextStep.step}</span>`;

        tr.innerHTML=`
          <td><span class="badge ${status.class}">${emp.staffType==='new'?'NEW':'EXS'}</span></td>
          <td><strong>${emp.id}</strong></td>
          <td>
            <div style="font-weight:600;">${emp.name}</div>
            <small style="color:#888">${emp.designation||''} ‚Ä¢ ${emp.nationality||''}</small>
          </td>
          <td>${nextStepHTML}</td>
          <td>${emp.branch}</td>
          <td>${expiryHTML}</td>
          <td><span style="font-weight:bold; color:${status.color}">${status.label}</span></td>
          <td>
            <button class="action-btn btn-edit" onclick="editEmployee('${emp.id}')" title="Edit"><i class="fas fa-edit"></i></button>
            <button class="action-btn btn-print" onclick="printReport('${emp.id}')" title="Print"><i class="fas fa-print"></i></button>
            <button class="action-btn btn-del" onclick="deleteEmployee('${emp.id}')" title="Delete"><i class="fas fa-trash"></i></button>
            <button class="action-btn" onclick="showEmployeeDocuments('${emp.id}')" title="Documents"><i class="fas fa-file-alt"></i></button>
          </td>`;
        tbody.appendChild(tr);
      });

      // Counters
      document.getElementById('totalCount').innerText=employees.length;
      document.getElementById('newCount').innerText=countNew;
      document.getElementById('activeCount').innerText=countActive;
      document.getElementById('alertCount').innerText=countAlert;

      // Notifications badge
      const notifBadge=document.getElementById('notifCount');
      if (notifCount>0) {
        notifBadge.innerText=notifCount;
        notifBadge.style.display='block';
      } else {
        notifBadge.style.display='none';
      }
      document.getElementById('tableCount').innerText=`Showing ${filteredEmployees.length} of ${employees.length} employees`;

    },300);
  }

  // Filter data
  function filterData() {
    const term=document.getElementById('searchInput').value.toLowerCase();
    const filterType=document.getElementById('typeFilter').value;
    filteredEmployees=employees.filter(e=> {
      const matchSearch=!term || e.id.toLowerCase().includes(term) || e.name.toLowerCase().includes(term) || (e.designation||'').toLowerCase().includes(term) || (e.branch||'').toLowerCase().includes(term);
      let matchType=true;
      if (filterType==='new') matchType=e.staffType==='new';
      else if (filterType==='existing') matchType=e.staffType==='existing';
      else if (filterType==='alert') {
        const status=getOverallStatus(e);
        matchType=status.category==='warning'||status.category==='expired'||(e.staffType==='new'&&status.category==='process');
      }
      return matchSearch && matchType;
    });
  }

  // Utility functions
  function getExpiryStatus(dateStr) {
    if (!dateStr) return { label:'-', class:'', warning:false, urgent:false, daysLeft:null };
    const today=new Date(); today.setHours(0,0,0,0);
    const target=new Date(dateStr); target.setHours(0,0,0,0);
    const diff=Math.ceil((target - today)/(1000*60*60*24));
    if (diff<=0) return { label:'EXPIRED', class:'date-expired', warning:false, urgent:true, daysLeft:0 };
    if (diff<=15) return { label:`${diff} Days Left`, class:'date-warning', warning:true, urgent:false, daysLeft:diff };
    return { label:`${diff} Days`, class:'', warning:false, urgent:false, daysLeft:diff };
  }

  function getOverallStatus(emp) {
    if (emp.staffType==='new') {
      const step=getNextStep(emp);
      if (step.step==="Ready for Handover") {
        return { label:"‚úÖ Ready", class:"status-ok", color:"#10b981", category:"ready" };
      } else {
        return { label:"‚öôÔ∏è In Process", class:"status-process", color:"#3b82f6", category:"process" };
      }
    } else {
      // existing staff
      const pass=getExpiryStatus(emp.passportExp);
      const visa=getExpiryStatus(emp.visaExp||emp.visaExpExisting);
      const med=getExpiryStatus(emp.medExpMain);
      if (pass.urgent || visa.urgent || med.urgent) {
        return { label:"üî¥ Expired", class:"status-expired", color:"#dc3545", category:"expired" };
      }
      if (pass.warning || visa.warning || med.warning) {
        return { label:"üü† Expiring Soon", class:"status-warning", color:"#f59e0b", category:"warning" };
      }
      return { label:"‚úÖ Active", class:"status-ok", color:"#10b981", category:"active" };
    }
  }

  function getNextStep(emp) {
    if (emp.staffType!=='new') return { step:"Routine Monitoring" };
    if (!emp.hireDate) return { step:"Approve Hire Date" };
    if (!emp.entryIssued) return { step:"Issue Entry Permit" };
    if (!emp.entryConfirmed) return { step:"Confirm Entry Permit Received" };
    if (!emp.dateEntry) return { step:"Record Entry Date" };
    if (!emp.laborContract) return { step:"Prepare & Sign Labor Contract" };
    if (!emp.medResult) return { step:"Schedule Medical / Get Result" };
    if (!emp.medInsurance) return { step:"Activate Medical Insurance" };
    if (!emp.eidRec) return { step:"Wait for EID Delivery" };
    if (!emp.visaIssued) return { step:"Issue Visa" };
    if (!emp.visaStamped) return { step:"Stamp Visa in Passport" };
    if (!emp.bankAccount) return { step:"Open Bank Account" };
    if (!emp.branchStartDate) return { step:"Send to Restaurant (Handover)" };
    return { step:"Ready for Handover" };
  }

  // Modal controls
  function openModal(id) {
    document.getElementById(id).classList.add('open');
    document.body.style.overflow='hidden';
  }
  function closeModal(id) {
    document.getElementById(id).classList.remove('open');
    document.body.style.overflow='';
  }

  // Add new employee
  function openAddModal() {
    currentEmployee=null;
    document.getElementById('staffForm').reset();
    document.getElementById('documentList').innerHTML='';
    document.getElementById('editId').value='';
    document.getElementById('modalTitle').innerText='Add New Staff';
    openModal('staffModal');
  }

  // Edit employee
  function editEmployee(id) {
    const e=employees.find(e=>e.id===id);
    if (!e) return;
    currentEmployee=e;
    populateForm(e);
    document.getElementById('modalTitle').innerText='Edit Staff';
    openModal('staffModal');
  }

  // Show employee documents
  function showEmployeeDocuments(id) {
    const emp=employees.find(e=>e.id===id);
    if (!emp) return;
    currentEmployee=emp;
    populateForm(emp);
    renderDocumentList(emp);
    document.getElementById('documentList').innerHTML=''; // reset
    openModal('staffModal');
  }

  // Populate form with employee data
  function populateForm(emp) {
    document.getElementById('editId').value=emp.id;
    document.getElementById('inpStaffType').value=emp.staffType||'existing';
    document.getElementById('inpId').value=emp.id;
    document.getElementById('inpName').value=emp.name;
    document.getElementById('inpNationality').value=emp.nationality||'';
    document.getElementById('inpDesignation').value=emp.designation||'';
    document.getElementById('inpBranch').value=emp.branch||'';
    document.getElementById('inpHireDate').value=emp.hireDate||'';

    document.getElementById('inpPassportExp').value=emp.passportExp||'';
    document.getElementById('inpVisaExpExisting').value=emp.visaExp||emp.visaExpExisting||'';

    // load documents
    if (emp.documents && emp.documents.length>0) {
      renderDocumentList(emp);
    } else {
      document.getElementById('documentList').innerHTML='';
    }
  }

  // Save employee data
  function saveStaff() {
    const id=document.getElementById('inpId').value.trim();
    const name=document.getElementById('inpName').value.trim();
    if (!id || !name) { showToast('ID and Name are required','error'); return; }

    const isNew=document.getElementById('editId').value==='';

    if (isNew && employees.some(e=>e.id===id)) {
      showToast('ID already exists','error');
      document.getElementById('inpId').focus();
      return;
    }

    const data=gatherFormData();

    if (isNew) {
      employees.unshift({...data, lastUpdated:new Date().toISOString()});
    } else {
      const idx=employees.findIndex(e=>e.id===document.getElementById('editId').value);
      if (idx!==-1) {
        employees[idx]={ ...employees[idx], ...data, lastUpdated:new Date().toISOString() };
      }
    }
    saveData();
    closeModal('staffModal');
    showToast(`Employee ${isNew?'added':'updated'} successfully`,'success');
  }

  function gatherFormData() {
    const data={};
    data.staffType=document.getElementById('inpStaffType').value;
    data.id=document.getElementById('inpId').value.trim();
    data.name=document.getElementById('inpName').value.trim();
    data.nationality=document.getElementById('inpNationality').value.trim();
    data.designation=document.getElementById('inpDesignation').value.trim();
    data.branch=document.getElementById('inpBranch').value.trim();
    data.hireDate=document.getElementById('inpHireDate').value;
    data.passportExp=document.getElementById('inpPassportExp').value;
    data.visaExp=document.getElementById('inpVisaExpExisting').value;
    // Save documents
    data.documents=currentEmployee && currentEmployee.documents? [...currentEmployee.documents]:[];
    return data;
  }

  // Delete employee
  function deleteEmployee(id) {
    if (confirm(`Are you sure you want to delete employee ${id}?`)) {
      employees=employees.filter(e=>e.id!==id);
      saveData();
    }
  }

  // Print report
  function printReport(id) {
    const emp=employees.find(e=>e.id===id);
    if (!emp) { showToast('Employee not found','error'); return; }
    populateReport(emp);
    window.print();
  }

  // Populate report (simplified)
  function populateReport(emp) {
    // fill #printArea with employee info
    // omitted for brevity
  }

  // --- Document Handling ---
  function handleFileUpload(event) {
    const files=event.target.files;
    if (!files || files.length===0) return;
    for (let i=0; i<files.length; i++) {
      const file=files[i];
      const reader=new FileReader();
      reader.onload=function(e) {
        const doc={ id: Date.now()+'_'+i, name:file.name, size:file.size, date:new Date().toISOString().split('T')[0], data:e.target.result };
        if (!currentEmployee.documents) currentEmployee.documents=[];
        currentEmployee.documents.push(doc);
        updateEmployeeData(currentEmployee);
        renderDocumentList(currentEmployee);
        showToast(`Document ${file.name} uploaded`, 'success');
      };
      reader.readAsDataURL(file);
    }
  }

  function renderDocumentList(emp) {
    const listDiv=document.getElementById('documentList');
    listDiv.innerHTML='';
    if (!emp.documents || emp.documents.length===0) {
      listDiv.innerHTML='<p>No documents uploaded.</p>';
      return;
    }
    emp.documents.forEach(doc => {
      listDiv.innerHTML+=`
      <div class="document-item">
        <div class="document-info">
          <i class="fas fa-file-alt"></i> <span class="document-name">${doc.name}</span>
        </div>
        <div style="display:flex; gap:4px;">
          <button onclick="viewDocument('${emp.id}', '${doc.id}')" title="View"><i class="fas fa-eye"></i></button>
          <button onclick="deleteDocument('${emp.id}', '${doc.id}')" title="Delete"><i class="fas fa-trash"></i></button>
        </div>
      </div>`;
    });
  }

  function viewDocument(empId, docId) {
    const emp=employees.find(e=>e.id===empId);
    if (!emp || !emp.documents) return;
    const doc=emp.documents.find(d=>d.id===docId);
    if (!doc) return;
    const win=window.open();
    win.document.write('<iframe style="width:100%;height:100%" src="'+doc.data+'"></iframe>');
  }

  function deleteDocument(empId, docId) {
    const emp=employees.find(e=>e.id===empId);
    if (!emp || !emp.documents) return;
    emp.documents=emp.documents.filter(d=>d.id!==docId);
    updateEmployeeData(emp);
    renderDocumentList(emp);
    showToast('Document deleted','success');
  }

  function updateEmployeeData(emp) {
    const idx=employees.findIndex(e=>e.id===emp.id);
    if (idx!==-1) {
      employees[idx]=emp;
      saveData();
      checkDocumentsExpiry(emp);
    }
  }

  // Check expiry of documents
  function checkDocumentsExpiry(emp) {
    if (!emp.documents || emp.documents.length===0) return;
    emp.documents.forEach(doc => {
      const expiryStatus=getExpiryStatus(doc.date);
      if (expiryStatus.category==='warning'||expiryStatus.category==='expired') {
        showToast(`${emp.name}'s document ${doc.name} is ${expiryStatus.label}`, expiryStatus.category==='warning'?'warning':'error');
      }
    });
  }

  // --- Notifications ---
  function updateNotifications() {
    const today=new Date();
    let notifCount=0;
    const notifications=[];
    employees.forEach(emp => {
      const status=getOverallStatus(emp);
      if (status.category==='expired') {
        notifications.push({ type:'error', message:`${emp.name} (${emp.id}) - Documents Expired`, employeeId:emp.id });
        notifCount++;
      } else if (status.category==='warning') {
        const pass=getExpiryStatus(emp.passportExp);
        const visa=getExpiryStatus(emp.visaExp||emp.visaExpExisting);
        const med=getExpiryStatus(emp.medExpMain);
        let expiringItem='Documents';
        if (pass.warning) expiringItem='Passport';
        else if (visa.warning) expiringItem='Visa';
        else if (med.warning) expiringItem='Medical Insurance';

        notifications.push({ type:'warning', message:`${emp.name} (${emp.id}) - ${expiringItem} expiring in ${pass.daysLeft || visa.daysLeft || med.daysLeft} days`, employeeId:emp.id });
        notifCount++;
      } else if (emp.staffType==='new' && status.category==='process') {
        const step=getNextStep(emp);
        notifications.push({ type:'info', message:`${emp.name} (${emp.id}) - ${step.step}`, employeeId:emp.id });
        notifCount++;
      }
      // Overdue Entry Permit confirmation
      if (emp.staffType==='new' && emp.entryIssued && !emp.entryConfirmed) {
        const issued=new Date(emp.entryIssued);
        const diffDays=Math.floor((today-issued)/(1000*60*60*24));
        if (diffDays>60) {
          notifications.push({ type:'warning', message:`${emp.name} (${emp.id}) - Entry Permit confirmation overdue (${diffDays} days)`, employeeId:emp.id });
          notifCount++;
        }
      }
    });
    // show notifications
    const listEl=document.getElementById('notificationsList');
    if (notifications.length===0) {
      listEl.innerHTML=`<div class="empty-state"><i class="fas fa-bell-slash"></i><h3>No alerts</h3><p>All employees are up to date</p></div>`;
    } else {
      let html=`<div style="display:flex; flex-direction:column; gap:10px;">`;
      notifications.forEach(n => {
        const icon=n.type==='error'?'üî¥':n.type==='warning'?'üü†':'üîµ';
        html+=`
        <div style="padding:12px; background:${n.type==='error'?'#fee':n.type==='warning'?'#ffd':'#eef'}; border-radius:6px; border-left:4px solid ${n.type==='error'?'#dc3545':n.type==='warning'?'#f59e0b':'#3b82f6'};">
          <div style="display:flex; align-items:center; gap:10px;">
            <span style="font-size:18px;">${icon}</span>
            <div style="flex:1;">
              <div style="font-weight:600; font-size:13px;">${n.message}</div>
              <small style="color:#666; font-size:11px;">Click arrow to view</small>
            </div>
            <button class="action-btn btn-edit" onclick="editEmployee('${n.employeeId}'); closeModal('notificationsModal')"><i class="fas fa-arrow-right"></i></button>
          </div>
        </div>`;
      });
      html+=`</div>`;
      listEl.innerHTML=html;
    }
  }
  function showNotifications() {
    updateNotifications();
    openModal('notificationsModal');
  }

  // --- Helper functions ---
  function toggleTheme() {
    const current=document.documentElement.getAttribute('data-theme');
    const newTheme=current==='dark'?'light':'dark';
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('cc_hr_theme', newTheme);
  }

  function setTodayDate() {
    // optional, set default date
  }

  // --- Utility ---
  function formatDate(dateStr) {
    if (!dateStr) return '';
    const d=new Date(dateStr);
    return d.toLocaleDateString('en-GB',{ day:'2-digit', month:'short', year:'numeric' });
  }

  // --- Modal controls ---
  document.querySelectorAll('.modal-overlay').forEach(mod => {
    document.addEventListener('keydown', e => { if(e.key==='Escape') { mod.classList.remove('open'); document.body.style.overflow=''; } });
    document.addEventListener('click', e => { if(e.target===mod) { mod.classList.remove('open'); document.body.style.overflow=''; } });
  });

  // Open modal
  function openModal(id) {
    document.getElementById(id).classList.add('open');
    document.body.style.overflow='hidden';
  }
  // Close modal
  function closeModal(id) {
    document.getElementById(id).classList.remove('open');
    document.body.style.overflow='';
  }

  // Save employee form
  function saveStaff() {
    const id=document.getElementById('inpId').value.trim();
    const name=document.getElementById('inpName').value.trim();
    if (!id || !name) { showToast('ID and Name are required','error'); return; }

    const isNew=document.getElementById('editId').value==='';

    if (isNew && employees.some(e=>e.id===id)) {
      showToast('ID already exists','error');
      document.getElementById('inpId').focus();
      return;
    }

    const data=gatherFormData();

    if (isNew) {
      employees.unshift({...data, lastUpdated:new Date().toISOString()});
    } else {
      const idx=employees.findIndex(e=>e.id===document.getElementById('editId').value);
      if (idx!==-1) {
        employees[idx]={ ...employees[idx], ...data, lastUpdated:new Date().toISOString() };
      }
    }
    saveData();
    closeModal('staffModal');
    showToast(`Employee ${isNew?'added':'updated'} successfully`,'success');
  }

  function gatherFormData() {
    const data={};
    data.staffType=document.getElementById('inpStaffType').value;
    data.id=document.getElementById('inpId').value.trim();
    data.name=document.getElementById('inpName').value.trim();
    data.nationality=document.getElementById('inpNationality').value.trim();
    data.designation=document.getElementById('inpDesignation').value.trim();
    data.branch=document.getElementById('inpBranch').value.trim();
    data.hireDate=document.getElementById('inpHireDate').value;
    data.passportExp=document.getElementById('inpPassportExp').value;
    data.visaExp=document.getElementById('inpVisaExpExisting').value;
    // Save documents
    data.documents=currentEmployee && currentEmployee.documents? [...currentEmployee.documents]:[];
    return data;
  }

  // Delete employee
  function deleteEmployee(id) {
    if (confirm(`Are you sure you want to delete employee ${id}?`)) {
      employees=employees.filter(e=>e.id!==id);
      saveData();
    }
  }

  // Print report
  function printReport(id) {
    const emp=employees.find(e=>e.id===id);
    if (!emp) { showToast('Employee not found','error'); return; }
    populateReport(emp);
    window.print();
  }

  // Populate report (simplified)
  function populateReport(emp) {
    // fill #printArea with employee info
  }

  // --- Document Handling ---
  function handleFileUpload(event) {
    const files=event.target.files;
    if (!files || files.length===0) return;
    for (let i=0; i<files.length; i++) {
      const file=files[i];
      const reader=new FileReader();
      reader.onload=function(e) {
        const doc={ id: Date.now()+'_'+i, name:file.name, size:file.size, date:new Date().toISOString().split('T')[0], data:e.target.result };
        if (!currentEmployee.documents) currentEmployee.documents=[];
        currentEmployee.documents.push(doc);
        updateEmployeeData(currentEmployee);
        renderDocumentList(currentEmployee);
        showToast(`Document ${file.name} uploaded`, 'success');
      };
      reader.readAsDataURL(file);
    }
  }

  function renderDocumentList(emp) {
    const listDiv=document.getElementById('documentList');
    listDiv.innerHTML='';
    if (!emp.documents || emp.documents.length===0) {
      listDiv.innerHTML='<p>No documents uploaded.</p>';
      return;
    }
    emp.documents.forEach(doc => {
      listDiv.innerHTML+=`
      <div class="document-item">
        <div class="document-info">
          <i class="fas fa-file-alt"></i> <span class="document-name">${doc.name}</span>
        </div>
        <div style="display:flex; gap:4px;">
          <button onclick="viewDocument('${emp.id}', '${doc.id}')" title="View"><i class="fas fa-eye"></i></button>
          <button onclick="deleteDocument('${emp.id}', '${doc.id}')" title="Delete"><i class="fas fa-trash"></i></button>
        </div>
      </div>`;
    });
  }

  function viewDocument(empId, docId) {
    const emp=employees.find(e=>e.id===empId);
    if (!emp || !emp.documents) return;
    const doc=emp.documents.find(d=>d.id===docId);
    if (!doc) return;
    const win=window.open();
    win.document.write('<iframe style="width:100%;height:100%" src="'+doc.data+'"></iframe>');
  }

  function deleteDocument(empId, docId) {
    const emp=employees.find(e=>e.id===empId);
    if (!emp || !emp.documents) return;
    emp.documents=emp.documents.filter(d=>d.id!==docId);
    updateEmployeeData(emp);
    renderDocumentList(emp);
    showToast('Document deleted','success');
  }

  function updateEmployeeData(emp) {
    const idx=employees.findIndex(e=>e.id===emp.id);
    if (idx!==-1) {
      employees[idx]=emp;
      saveData();
      checkDocumentsExpiry(emp);
    }
  }

  // Check expiry dates for documents
  function checkDocumentsExpiry(emp) {
    if (!emp.documents || emp.documents.length===0) return;
    emp.documents.forEach(doc => {
      const expiryStatus=getExpiryStatus(doc.date);
      if (expiryStatus.category==='warning'||expiryStatus.category==='expired') {
        showToast(`${emp.name}'s document ${doc.name} is ${expiryStatus.label}`, expiryStatus.category==='warning'?'warning':'error');
      }
    });
  }

  // --- Notifications ---
  function updateNotifications() {
    const today=new Date();
    let notifCount=0;
    const notifications=[];
    employees.forEach(emp => {
      const status=getOverallStatus(emp);
      if (status.category==='expired') {
        notifications.push({ type:'error', message:`${emp.name} (${emp.id}) - Documents Expired`, employeeId:emp.id });
        notifCount++;
      } else if (status.category==='warning') {
        const pass=getExpiryStatus(emp.passportExp);
        const visa=getExpiryStatus(emp.visaExp||emp.visaExpExisting);
        const med=getExpiryStatus(emp.medExpMain);
        let expiringItem='Documents';
        if (pass.warning) expiringItem='Passport';
        else if (visa.warning) expiringItem='Visa';
        else if (med.warning) expiringItem='Medical Insurance';

        notifications.push({ type:'warning', message:`${emp.name} (${emp.id}) - ${expiringItem} expiring in ${pass.daysLeft || visa.daysLeft || med.daysLeft} days`, employeeId:emp.id });
        notifCount++;
      } else if (emp.staffType==='new' && status.category==='process') {
        const step=getNextStep(emp);
        notifications.push({ type:'info', message:`${emp.name} (${emp.id}) - ${step.step}`, employeeId:emp.id });
        notifCount++;
      }
      if (emp.staffType==='new' && emp.entryIssued && !emp.entryConfirmed) {
        const issued=new Date(emp.entryIssued);
        const diffDays=Math.floor((today-issued)/(1000*60*60*24));
        if (diffDays>60) {
          notifications.push({ type:'warning', message:`${emp.name} (${emp.id}) - Entry Permit confirmation overdue (${diffDays} days)`, employeeId:emp.id });
          notifCount++;
        }
      }
    });
    // show notifications
    const listEl=document.getElementById('notificationsList');
    if (notifications.length===0) {
      listEl.innerHTML=`<div class="empty-state"><i class="fas fa-bell-slash"></i><h3>No alerts</h3><p>All employees are up to date</p></div>`;
    } else {
      let html=`<div style="display:flex; flex-direction:column; gap:10px;">`;
      notifications.forEach(n => {
        const icon=n.type==='error'?'üî¥':n.type==='warning'?'üü†':'üîµ';
        html+=`
        <div style="padding:12px; background:${n.type==='error'?'#fee':n.type==='warning'?'#ffd':'#eef'}; border-radius:6px; border-left:4px solid ${n.type==='error'?'#dc3545':n.type==='warning'?'#f59e0b':'#3b82f6'};">
          <div style="display:flex; align-items:center; gap:10px;">
            <span style="font-size:18px;">${icon}</span>
            <div style="flex:1;">
              <div style="font-weight:600; font-size:13px;">${n.message}</div>
              <small style="color:#666; font-size:11px;">Click arrow to view</small>
            </div>
            <button class="action-btn btn-edit" onclick="editEmployee('${n.employeeId}'); closeModal('notificationsModal')"><i class="fas fa-arrow-right"></i></button>
          </div>
        </div>`;
      });
      html+=`</div>`;
      listEl.innerHTML=html;
    }
  }
  function showNotifications() {
    updateNotifications();
    openModal('notificationsModal');
  }

  // --- Helper functions ---
  function getNextStep(emp) {
    if (emp.staffType!=='new') return { step:"Routine Monitoring" };
    if (!emp.hireDate) return { step:"Approve Hire Date" };
    if (!emp.entryIssued) return { step:"Issue Entry Permit" };
    if (!emp.entryConfirmed) return { step:"Confirm Entry Permit Received" };
    if (!emp.dateEntry) return { step:"Record Entry Date" };
    if (!emp.laborContract) return { step:"Prepare & Sign Labor Contract" };
    if (!emp.medResult) return { step:"Schedule Medical / Get Result" };
    if (!emp.medInsurance) return { step:"Activate Medical Insurance" };
    if (!emp.eidRec) return { step:"Wait for EID Delivery" };
    if (!emp.visaIssued) return { step:"Issue Visa" };
    if (!emp.visaStamped) return { step:"Stamp Visa in Passport" };
    if (!emp.bankAccount) return { step:"Open Bank Account" };
    if (!emp.branchStartDate) return { step:"Send to Restaurant (Handover)" };
    return { step:"Ready for Handover" };
  }

  // Show employee data for editing
  function editEmployee(id) {
    const emp=employees.find(e=>e.id===id);
    if (!emp) return;
    currentEmployee=emp;
    populateForm(emp);
    renderDocumentList(emp);
    document.getElementById('editId').value=emp.id;
    document.getElementById('modalTitle').innerText='Edit Staff';
    openModal('staffModal');
  }

  // Show employee documents
  function showEmployeeDocuments(id) {
    const emp=employees.find(e=>e.id===id);
    if (!emp) return;
    currentEmployee=emp;
    populateForm(emp);
    renderDocumentList(emp);
    document.getElementById('editId').value=emp.id;
    document.getElementById('modalTitle').innerText='Edit Staff & Documents';
    openModal('staffModal');
  }

  // Populate form
  function populateForm(emp) {
    document.getElementById('inpStaffType').value=emp.staffType||'existing';
    document.getElementById('inpId').value=emp.id;
    document.getElementById('inpName').value=emp.name;
    document.getElementById('inpNationality').value=emp.nationality||'';
    document.getElementById('inpDesignation').value=emp.designation||'';
    document.getElementById('inpBranch').value=emp.branch||'';
    document.getElementById('inpHireDate').value=emp.hireDate||'';
    document.getElementById('inpPassportExp').value=emp.passportExp||'';
    document.getElementById('inpVisaExpExisting').value=emp.visaExp||emp.visaExpExisting||'';
    if (emp.documents && emp.documents.length>0) {
      renderDocumentList(emp);
    } else {
      document.getElementById('documentList').innerHTML='';
    }
  }

</script>
</body>
</html>
